<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroSphere - Weather Forecast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'poppins': ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#22c55e',
                        'primary-dark': '#16a34a',
                        'dark-bg': '#0f172a',
                        'light-bg': '#f1f5f9',
                        'text-dark': '#0f172a',
                        'card-bg': '#1e293b', 
                        'border-color': 'rgba(255, 255, 255, 0.1)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #0b1120; /* Slightly darker bg for depth */
        }
        .main-container::before {
            content: '';
            position: absolute;
            top: -20%;
            left: -10%;
            width: 500px;
            height: 500px;
            background-image: radial-gradient(circle, rgba(34, 197, 94, 0.15), transparent 70%);
            filter: blur(100px);
            z-index: 0;
            pointer-events: none;
        }
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        .loader {
            border: 5px solid #475569;
            border-top: 5px solid #22c55e;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hourly-forecast::-webkit-scrollbar { height: 8px; }
        .hourly-forecast::-webkit-scrollbar-track { background: #0f172a; border-radius: 4px; }
        .hourly-forecast::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 4px; }
        .hourly-forecast::-webkit-scrollbar-thumb:hover { background-color: #64748b; }
        .forecast-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding: 0 1rem;
        }
        details[open] .forecast-details {
            max-height: 200px;
            padding: 1rem;
        }
        details summary::-webkit-details-marker { display: none; }
        details summary { list-style: none; }
        details summary .arrow { transition: transform 0.3s ease; }
        details[open] summary .arrow { transform: rotate(90deg); }

        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 180px;
            background-color: #111827;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -90px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .bg-card-bg {
            background: linear-gradient(145deg, #2a3a51, #1a2538);
        }
    </style>
</head>
<body class="bg-dark-bg text-slate-300 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-7xl mx-auto bg-dark-bg rounded-2xl shadow-2xl shadow-black/30 overflow-hidden relative main-container">
        <main class="text-white p-6 md:p-8 relative z-10">
            
            <div id="loader" class="absolute inset-0 bg-dark-bg/80 backdrop-blur-sm flex items-center justify-center rounded-2xl z-20">
                <div class="loader"></div>
            </div>

            <div id="weather-content" class="opacity-0 transition-opacity duration-500">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <!-- Main Content Panel -->
                    <div class="lg:col-span-8 space-y-6">
                        <header class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                            <a href="C:\Users\jaini\Desktop\javascript\index.html"><div class="flex items-center space-x-3">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z" fill="#16a34a"/>
                                    <path d="M12 6C9.17 6 6.84 7.63 5.5 10.04C6.87 8.5 8.83 7.5 11 7.5V10.5L14.5 7L11 3.5V6.5C10.5 6.5 10 6.5 9.5 6.5C8.81 6.5 8.16 6.62 7.55 6.81C8.83 5.67 10.41 5 12 5C13.59 5 15.17 5.67 16.45 6.81C17.16 6.62 17.81 6.5 18.5 6.5C19 6.5 19.5 6.5 20 6.5V3.5L16.5 7L20 10.5V7.5C18.17 7.5 16.13 8.5 14.5 10.04C13.16 7.63 10.83 6 12 6Z" fill="#22c55e"/>
                                </svg>
                                <h1 class="text-3xl font-bold tracking-wider">AgroSphere Weather</h1>
                            </div></a>
                            <form id="search-form" class="w-full md:w-auto flex">
                                <input type="text" id="city-input" placeholder="Enter city name..." class="w-full md:w-64 px-4 py-2 rounded-l-full bg-card-bg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary transition-all">
                                <button type="submit" class="bg-primary hover:bg-primary-dark px-5 py-2 rounded-r-full font-semibold transition-all">Search</button>
                            </form>
                        </header>
                        
                        <div id="error-message" class="hidden text-center bg-red-500/20 border border-red-500 text-red-300 p-3 rounded-lg">
                            <p id="error-text">City not found.</p>
                        </div>
                        
                        <section class="bg-card-bg p-6 rounded-2xl border border-border-color flex flex-col md:flex-row items-center justify-between">
                            <div class="text-center md:text-left">
                               <h2 id="city-name" class="text-4xl font-bold">Loading...</h2>
                               <p id="current-date" class="text-lg text-slate-400">Loading date...</p>
                               <p id="temperature" class="text-7xl font-bold mt-4">--°</p>
                               <p id="weather-description" class="text-xl capitalize text-slate-300">Loading...</p>
                           </div>
                           <div class="flex items-center justify-center mt-6 md:mt-0">
                               <div id="weather-icon-main" class="w-48 h-48"></div>
                           </div>
                       </section>

                       <section class="bg-card-bg p-6 rounded-2xl border border-border-color">
                            <h3 class="text-lg font-semibold mb-4">Next 48 Hours</h3>
                            <div id="hourly-forecast-container" class="hourly-forecast flex space-x-4 overflow-x-auto pb-4">
                                <!-- Hourly forecast cards will be injected here -->
                            </div>
                        </section>

                        <section class="bg-card-bg p-6 rounded-2xl border border-border-color">
                            <h3 class="text-lg font-semibold mb-4">7-Day Forecast</h3>
                            <div id="forecast-container" class="space-y-2">
                                <!-- Daily forecast rows will be injected here -->
                            </div>
                        </section>
                    </div>

                    <!-- Side Panel -->
                    <div class="lg:col-span-4 space-y-6">
                        <section class="bg-card-bg p-6 rounded-2xl border border-border-color h-full">
                            <h3 class="text-xl font-semibold mb-4 pb-2">Essential Farming Info</h3>
                            <div id="essential-info-container" class="grid grid-cols-2 gap-3">
                                <!-- Data points will be injected here -->
                            </div>
                        </section>
                        <section class="bg-card-bg p-6 rounded-2xl border border-border-color">
                            <h3 class="text-lg font-semibold mb-4">Cloud Cover Map</h3>
                            <div class="aspect-video bg-dark-bg rounded-lg overflow-hidden">
                                <iframe id="cloud-map" class="w-full h-full border-0"
                                    src="https://embed.windy.com/embed.html?lat=28.614&lon=77.209&zoom=5&level=surface&overlay=clouds"
                                    frameborder="0"></iframe>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const GEOCODING_API_URL = 'https://geocoding-api.open-meteo.com/v1/search';
            const WEATHER_API_URL = 'https://api.open-meteo.com/v1/forecast';
            const DEFAULT_CITY = 'New Delhi';

            // --- DOM ELEMENTS ---
            const searchForm = document.getElementById('search-form');
            const cityInput = document.getElementById('city-input');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const weatherContent = document.getElementById('weather-content');
            const loader = document.getElementById('loader');
            const cityNameEl = document.getElementById('city-name');
            const currentDateEl = document.getElementById('current-date');
            const weatherIconMainEl = document.getElementById('weather-icon-main');
            const temperatureEl = document.getElementById('temperature');
            const weatherDescriptionEl = document.getElementById('weather-description');
            const essentialInfoContainer = document.getElementById('essential-info-container');
            const forecastContainer = document.getElementById('forecast-container');
            const hourlyForecastContainer = document.getElementById('hourly-forecast-container');
            const cloudMapEl = document.getElementById('cloud-map');

            // --- ANIMATED SVG ICONS ---
            const weatherIcons = {
                sunny: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" class="w-full h-full"><g><circle cx="32" cy="32" r="11.25" fill="#fcd34d"/><path d="M32 15.75V9.5m0 45v-6.25m11.5-27.75l4.42-4.42M16.08 47.92l4.42-4.42m0-22l-4.42-4.42M43.5 47.92l-4.42-4.42M15.75 32H9.5m45 0h-6.25" fill="none" stroke="#fcd34d" stroke-linecap="round" stroke-width="3.5" stroke-dasharray="0.1 6.5"><animateTransform attributeName="transform" type="rotate" values="0 32 32; 360 32 32" dur="45s" repeatCount="indefinite"/></path></g></svg>`,
                cloudy: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" class="w-full h-full"><g><path d="M47.25 41.25a10.05 10.05 0 00-19.5-2.5 8.1 8.1 0 00-15 4.5 8.35 8.35 0 008.25 8.25h26.25a10.2 10.2 0 000-20.25 10.05 10.05 0 00-9.25 6.25" fill="#d1d5db" stroke="#d1d5db" stroke-linejoin="round" stroke-width="1.5"><animateTransform attributeName="transform" type="translate" values="-3 0; 3 0; -3 0" dur="7s" repeatCount="indefinite"/></path></g></svg>`,
                rainy: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" class="w-full h-full"><g><path d="M47.25 41.25a10.05 10.05 0 00-19.5-2.5 8.1 8.1 0 00-15 4.5 8.35 8.35 0 008.25 8.25h26.25a10.2 10.2 0 000-20.25 10.05 10.05 0 00-9.25 6.25" fill="#9ca3af" stroke="#9ca3af" stroke-linejoin="round" stroke-width="1.5"><animateTransform attributeName="transform" type="translate" values="-3 0; 3 0; -3 0" dur="7s" repeatCount="indefinite"/></path><path d="M28.17 52.83l-1.07 2.08m5-1.04l-1.07 2.08m5-1.04l-1.07 2.08" fill="none" stroke="#60a5fa" stroke-linecap="round" stroke-width="2"><animate attributeName="stroke" values="#60a5fa; #93c5fd; #60a5fa" dur="1s" repeatCount="indefinite"/><animateTransform attributeName="transform" type="translate" values="0 0; 0 10; 0 0" dur="1s" repeatCount="indefinite" begin="0s"/><animate attributeName="opacity" values="0;1;1;0" dur="1s" repeatCount="indefinite"/></path></g></svg>`
            };
             const infoIcons = {
                wind: `<svg class="w-10 h-10 text-slate-400" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="M32 16 A16 16 0 0 1 48 32 A16 16 0 0 1 32 48 A16 16 0 0 1 16 32 A16 16 0 0 1 32 16 Z" fill="none" stroke="currentColor" stroke-width="3"/><path d="M32 0 L32 64" fill="none" stroke="currentColor" stroke-width="3"/><path d="M0 32 L64 32" fill="none" stroke="currentColor" stroke-width="3"/><g><path d="M32 32 L48 16" fill="none" stroke="currentColor" stroke-width="3"/><path d="M32 32 L16 48" fill="none" stroke="currentColor" stroke-width="3"/><animateTransform attributeName="transform" type="rotate" from="0 32 32" to="360 32 32" dur="2s" repeatCount="indefinite"/></g></svg>`,
                humidity: `<svg class="w-10 h-10 text-sky-400" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g><path d="M32 60 C 32 60 48 48 48 32 C 48 16 32 0 32 0 C 32 0 16 16 16 32 C 16 48 32 60 32 60 Z" fill="none" stroke="currentColor" stroke-width="3"/><path d="M32 50 C 32 50 42 42 42 32 C 42 22 32 12 32 12 C 32 12 22 22 22 32 C 22 42 32 50 32 50 Z" fill="currentColor"><animate attributeName="opacity" values="1;0.5;1" dur="2s" repeatCount="indefinite"/></path></g></svg>`,
                rain: `<svg class="w-10 h-10 text-blue-400" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g><path d="M16 40 C 16 32 24 24 32 24 C 40 24 48 32 48 40" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"/><path d="M24 56 L24 48 m8 8 L32 40 m8 8 L40 48" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><animateTransform attributeName="transform" type="translate" values="0 0; 0 8; 0 0" dur="1s" repeatCount="indefinite"/></path></g></svg>`,
                uv: `<svg class="w-10 h-10 text-amber-400" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g><circle cx="32" cy="32" r="6" fill="currentColor"/><path d="M32 8 V16 M32 48 V56 M8 32 H16 M48 32 H56 M16 16 L22 22 M42 42 L48 48 M16 48 L22 42 M42 22 L48 16" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><animate attributeName="stroke-width" values="3;5;3" dur="2s" repeatCount="indefinite"/></path></g></svg>`,
                cloud: `<svg class="w-10 h-10 text-slate-400" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g><path d="M48 48 C 56 48 56 32 48 32 C 48 24 40 24 40 24 C 32 16 24 16 24 24 C 16 24 16 32 24 32 L48 32 Z" fill="currentColor"><animateTransform attributeName="transform" type="translate" values="-3 0; 3 0; -3 0" dur="5s" repeatCount="indefinite"/></path></g></svg>`,
                wind_dir: `<svg class="w-10 h-10 text-slate-400" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g transform="rotate(0, 32, 32)"><circle cx="32" cy="32" r="28" fill="none" stroke="currentColor" stroke-width="3"/><path d="M32 8 L 24 24 L32 20 L40 24 Z" fill="currentColor"/></g></svg>`,
                sunrise: `<svg class="w-10 h-10 text-orange-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707m12.728 0A6 6 0 106.343 17.657 6 6 0 0019.071 6.343z"/></svg>`,
                sunset: `<svg class="w-10 h-10 text-orange-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-1m0-16V3m9 9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707m12.728 0A6 6 0 106.343 17.657 6 6 0 0019.071 6.343z"/></svg>`,
                sunshine: `<svg class="w-6 h-6 mr-2 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636" /></svg>`,
            };
            
            // --- HELPER FUNCTIONS ---
            const showLoader = () => { loader.classList.remove('hidden'); weatherContent.classList.add('opacity-0'); }
            const hideLoader = () => { loader.classList.add('hidden'); weatherContent.classList.remove('opacity-0'); }
            const showError = (message) => { errorText.textContent = message; errorMessage.classList.remove('hidden'); };
            const hideError = () => errorMessage.classList.add('hidden');
            const getWeatherDescription = (code) => ({0: 'Clear Sky', 1: 'Mainly Clear', 2: 'Partly Cloudy', 3: 'Overcast', 45: 'Fog', 48: 'Rime Fog', 51: 'Light Drizzle', 53: 'Drizzle', 55: 'Dense Drizzle', 61: 'Slight Rain', 63: 'Rain', 65: 'Heavy Rain', 80: 'Rain Showers', 81: 'Rain Showers', 82: 'Violent Showers', 95: 'Thunderstorm'}[code] || 'Unknown');
            const getWeatherIconKey = (code) => (code <= 1) ? 'sunny' : (code <= 3 || (code >= 45 && code <= 48)) ? 'cloudy' : 'rainy';
            const degToCompass = (num) => {
                if (typeof num !== 'number') return 'N/A';
                const val = Math.floor((num / 22.5) + 0.5);
                const arr = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
                return arr[(val % 16)];
            }

            // --- UI UPDATE FUNCTIONS ---
            const updateUI = (data, cityName) => {
                const { current, daily } = data;
                cityNameEl.textContent = cityName;
                currentDateEl.textContent = new Date().toLocaleString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                weatherIconMainEl.innerHTML = weatherIcons[getWeatherIconKey(current?.weather_code)];
                temperatureEl.textContent = `${Math.round(current?.temperature_2m ?? 0)}°`;
                weatherDescriptionEl.textContent = getWeatherDescription(current?.weather_code);
                updateEssentialInfo(daily, current);
                update7DayForecast(daily);
            };

            const updateEssentialInfo = (daily, current) => {
                const windDirIcon = infoIcons.wind_dir.replace('rotate(0, 32, 32)', `rotate(${current?.wind_direction_10m ?? 0}, 32, 32)`);

                const info = {
                    wind: { value: `${Math.round(current?.wind_speed_10m ?? 0)} km/h`, label: 'Wind', icon: infoIcons.wind },
                    humidity: { value: `${current?.relative_humidity_2m ?? 0}%`, label: 'Humidity', icon: infoIcons.humidity },
                    rain: { value: `${daily?.precipitation_probability_max?.[0] ?? 0}%`, label: 'Rain', icon: infoIcons.rain },
                    uv: { value: (daily?.uv_index_max?.[0] ?? 0).toFixed(1), label: 'UV Index', icon: infoIcons.uv },
                    cloud: { value: `${current?.cloud_cover ?? 0}%`, label: 'Cloud Cover', icon: infoIcons.cloud },
                    wind_dir: { value: degToCompass(current?.wind_direction_10m), label: 'Wind Dir.', icon: windDirIcon },
                    sunrise: { value: daily?.sunrise?.[0] ? new Date(daily.sunrise[0]).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : '--', label: 'Sunrise', icon: infoIcons.sunrise },
                    sunset: { value: daily?.sunset?.[0] ? new Date(daily.sunset[0]).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : '--', label: 'Sunset', icon: infoIcons.sunset },
                };
                essentialInfoContainer.innerHTML = Object.values(info).map(item => `
                    <div class="flex items-center space-x-3 bg-dark-bg p-3 rounded-xl hover:bg-slate-700/50 transition-all col-span-1">
                        ${item.icon}
                        <div>
                             <p class="font-semibold text-white text-lg">${item.value}</p>
                             <p class="text-xs text-slate-400">${item.label}</p>
                        </div>
                    </div>
                `).join('');
            };
            
            const update7DayForecast = (daily) => {
                forecastContainer.innerHTML = '';
                for (let i = 0; i < 7; i++) {
                    if (!daily?.time?.[i]) continue;
                    const date = new Date(daily.time[i]);
                    let day = i === 0 ? 'Today' : i === 1 ? 'Tomorrow' : date.toLocaleDateString('en-US', { weekday: 'short' });
                    
                    const sunrise = new Date(daily.sunrise[i]);
                    const sunset = new Date(daily.sunset[i]);
                    const daylightMillis = sunset - sunrise;
                    
                    const cloudCoverPercent = (daily.cloud_cover_mean?.[i] ?? 50) / 100;
                    const sunshineRatio = 1 - (cloudCoverPercent * 0.75);
                    
                    const sunshineMillis = daylightMillis * Math.max(0, sunshineRatio);
                    const sunshineHours = Math.floor(sunshineMillis / 3600000);
                    const sunshineMinutes = Math.round((sunshineMillis % 3600000) / 60000);
                    const weatherCode = daily.weather_code[i];

                    forecastContainer.innerHTML += `
                        <details class="bg-dark-bg rounded-lg group" ${i === 0 ? 'open' : ''}>
                            <summary class="flex items-center justify-between p-3 cursor-pointer hover:bg-slate-700/50 rounded-lg transition-all">
                                <p class="font-medium w-1/4">${day}</p>
                                <div class="flex items-center space-x-2 w-1/2 justify-center">
                                    <div class="w-8 h-8">${weatherIcons[getWeatherIconKey(weatherCode)]}</div>
                                </div>
                                <div class="flex items-center justify-end w-1/4">
                                    <p class="font-medium text-right mr-3 text-sm">
                                        <span class="text-white">${Math.round(daily.temperature_2m_max[i])}°</span>
                                        <span class="text-slate-400">${Math.round(daily.temperature_2m_min[i])}°</span>
                                    </p>
                                </div>
                            </summary>
                            <div class="forecast-details border-t border-border-color">
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                                    <div class="flex items-center">${infoIcons.rain.replace('w-10 h-10', 'w-6 h-6 mr-2').replace('text-blue-400','text-slate-400')}<span>Rain: <strong>${daily.precipitation_probability_max[i]}%</strong></span></div>
                                    <div class="flex items-center">${infoIcons.wind.replace('w-10 h-10', 'w-6 h-6 mr-2')}<span>Wind: <strong>${Math.round(daily.wind_speed_10m_max[i])} km/h</strong></span></div>
                                    <div class="flex items-center tooltip">
                                        ${infoIcons.sunshine}
                                        <span>Sunshine: <strong>${sunshineHours}h ${sunshineMinutes}m</strong></span>
                                        <span class="tooltiptext">Estimated duration of direct sun based on cloud cover forecast.</span>
                                    </div>
                                </div>
                            </div>
                        </details>`;
                }
            };
            
            const updateHourlyForecast = (hourly) => {
                hourlyForecastContainer.innerHTML = '';
                if (!hourly?.time) return;
                const now = new Date();
                let startIndex = hourly.time.findIndex(t => new Date(t) > now);
                if (startIndex === -1) startIndex = 0;
                for (let i = startIndex; i < startIndex + 48 && i < hourly.time.length; i++) {
                     const date = new Date(hourly.time[i]);
                     const timeString = i === startIndex ? 'Now' : date.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
                    hourlyForecastContainer.innerHTML += `
                        <div class="flex flex-col items-center space-y-2 text-center flex-shrink-0 bg-dark-bg p-3 rounded-lg w-24">
                            <p class="font-medium text-sm">${timeString}</p>
                            <div class="w-10 h-10">${weatherIcons[getWeatherIconKey(hourly.weather_code[i])]}</div>
                            <p class="font-bold text-xl">${Math.round(hourly.temperature_2m[i])}°</p>
                            <div class="flex items-center space-x-1 text-xs text-slate-400">${infoIcons.humidity.replace('w-10 h-10', 'w-4 h-4')}<span>${hourly.relative_humidity_2m[i]}%</span></div>
                        </div>`;
                }
            };
            
            const updateCloudMap = (lat, lon) => {
                cloudMapEl.src = `https://embed.windy.com/embed.html?lat=${lat}&lon=${lon}&zoom=6&level=surface&overlay=clouds`;
            };

            // --- DATA FETCHING ---
            const fetchWeatherForCoords = async (lat, lon, name) => {
                 showLoader(); hideError();
                 try {
                    const params = `latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,cloud_cover,wind_direction_10m&hourly=temperature_2m,relative_humidity_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,relative_humidity_2m_max,sunrise,sunset,uv_index_max,precipitation_probability_max,wind_speed_10m_max,cloud_cover_mean,wind_direction_10m_dominant&timezone=auto`;
                    const weatherRes = await fetch(`${WEATHER_API_URL}?${params}`);
                    if (!weatherRes.ok) throw new Error("Could not fetch weather data.");
                    const data = await weatherRes.json();
                    if (!data.current || !data.daily) throw new Error("API response is missing required data.");
                    updateUI(data, name);
                    updateHourlyForecast(data.hourly);
                    updateCloudMap(lat, lon);
                 } catch (err) {
                     console.error("Weather Fetch Error:", err); showError(err.message);
                 } finally { hideLoader(); }
            };

            const fetchWeatherForCity = async (city) => {
                showLoader(); hideError();
                try {
                    const geoRes = await fetch(`${GEOCODING_API_URL}?name=${city}&count=1&language=en&format=json`);
                    if (!geoRes.ok) throw new Error("Could not find city coordinates.");
                    const geoData = await geoRes.json();
                    if (!geoData.results || geoData.results.length === 0) throw new Error(`City "${city}" not found.`);
                    const { latitude, longitude, name } = geoData.results[0];
                    await fetchWeatherForCoords(latitude, longitude, name);
                } catch (err) {
                    console.error("City Fetch Error:", err); showError(err.message); hideLoader();
                }
            };

            // --- EVENT LISTENERS & INITIALIZATION ---
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const city = cityInput.value.trim();
                if (city) fetchWeatherForCity(city); cityInput.value = '';
            });

            const init = () => {
                navigator.geolocation ? navigator.geolocation.getCurrentPosition(
                    (pos) => fetchWeatherForCoords(pos.coords.latitude, pos.coords.longitude, "Your Location"),
                    () => fetchWeatherForCity(DEFAULT_CITY)
                ) : fetchWeatherForCity(DEFAULT_CITY);
            };

            init();
        });
    </script>
</body>
</html>
